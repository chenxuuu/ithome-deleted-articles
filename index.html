<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章列表与日历视图</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
            background-color: #f8f9fa;
        }
        h1 {
            text-align: center;
            color: #495057;
        }
        
        /* 加载器样式 */
        #loader {
            text-align: center;
            padding: 40px;
        }
        #loader h3 {
            margin-bottom: 20px;
            color: #495057;
        }
        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 15px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            position: relative;
        }
        .progress-text {
            margin-top: 10px;
            color: #6c757d;
            font-size: 14px;
        }
        .loading-steps {
            text-align: left;
            max-width: 300px;
            margin: 20px auto;
        }
        .loading-step {
            padding: 5px 0;
            color: #6c757d;
            font-size: 14px;
        }
        .loading-step.active {
            color: #007bff;
            font-weight: bold;
        }
        .loading-step.completed {
            color: #28a745;
        }
        .loading-step::before {
            content: "⏳ ";
            margin-right: 8px;
        }
        .loading-step.active::before {
            content: "🔄 ";
        }
        .loading-step.completed::before {
            content: "✅ ";
        }
        
        /* 年份切换器 */
        #year-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        #year-selector select {
            padding: 8px 15px;
            font-size: 16px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #fff;
        }
        
        /* 月份日历网格 */
        #calendar-container {
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
        }
        #month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .month-calendar {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .month-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            background-color: #fff;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        .day-cell:hover {
            background-color: #e3f2fd;
        }
        .day-cell.has-articles {
            background-color: #bbdefb;
            font-weight: bold;
        }
        .day-cell.active {
            background-color: #2196f3;
            color: white;
        }
        .day-cell .article-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #f44336;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        /* 文章列表样式 */
        #article-list {
            max-height: 600px;
            overflow-y: auto;
        }
        #article-list article {
            background-color: #fff;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        #article-list h3 {
            margin: 0 0 10px;
            font-size: 1.1em;
            color: #212529;
        }
        #article-list .meta {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }
        #article-list .links a {
            color: #007bff;
            text-decoration: none;
            margin-right: 15px;
            font-size: 0.9em;
        }
        #article-list .links a:hover {
            text-decoration: underline;
        }
        
        /* 统计信息 */
        .stats {
            text-align: center;
            color: #6c757d;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <h1>文章归档</h1>

    <div id="loader">
        <h3>正在加载数据</h3>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">准备开始...</div>
        
        <div class="loading-steps">
            <div class="loading-step" id="step-fetch">下载 CSV 文件</div>
            <div class="loading-step" id="step-parse">解析数据格式</div>
            <div class="loading-step" id="step-process">处理文章数据</div>
            <div class="loading-step" id="step-calendar">生成日历视图</div>
            <div class="loading-step" id="step-render">渲染页面内容</div>
        </div>
    </div>

    <div id="year-selector" style="display: none;">
        <label for="year-select">选择年份：</label>
        <select id="year-select">
            <option value="">全部年份</option>
        </select>
    </div>

    <div id="calendar-container" style="display: none;">
        <h2>日历视图</h2>
        <div class="stats" id="stats"></div>
        <div id="month-grid"></div>
    </div>

    <div id="article-list"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const loader = document.getElementById('loader');
        const articleList = document.getElementById('article-list');
        const calendarContainer = document.getElementById('calendar-container');
        const yearSelector = document.getElementById('year-selector');
        const yearSelect = document.getElementById('year-select');
        const monthGrid = document.getElementById('month-grid');
        const stats = document.getElementById('stats');
        
        // 进度相关元素
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        let articlesByDate = new Map();
        let allArticles = [];
        let currentYear = '';
        let activeDateElement = null;

        // 更新进度
        function updateProgress(percentage, text, stepId) {
            progressBar.style.width = percentage + '%';
            progressText.textContent = text;
            
            // 更新步骤状态
            if (stepId) {
                // 重置所有步骤状态
                document.querySelectorAll('.loading-step').forEach(step => {
                    step.classList.remove('active', 'completed');
                });
                
                // 标记已完成的步骤和当前步骤
                const stepIds = ['step-fetch', 'step-parse', 'step-process', 'step-calendar', 'step-render'];
                const currentIndex = stepIds.indexOf(stepId);
                
                stepIds.forEach((id, index) => {
                    const step = document.getElementById(id);
                    if (index < currentIndex) {
                        step.classList.add('completed');
                    } else if (index === currentIndex) {
                        step.classList.add('active');
                    }
                });
            }
        }

        // 延迟函数，确保UI能够更新
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 分批处理数据，避免阻塞UI
        async function processDataInBatches(lines, batchSize = 50) {
            const articles = [];
            const totalLines = lines.length;
            
            for (let i = 0; i < lines.length; i += batchSize) {
                const batch = lines.slice(i, i + batchSize);
                
                // 处理当前批次
                for (const line of batch) {
                    const parts = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            parts.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    parts.push(current);
                    
                    if (parts.length >= 4) {
                        const [id, time, title, url] = parts;
                        const cleanTitle = title.replace(/^"|"$/g, '');
                        
                        articles.push({
                            id: id.trim(),
                            time: new Date(time.trim()),
                            title: cleanTitle.trim(),
                            url: url.trim()
                        });
                    }
                }
                
                // 更新进度
                const progress = 40 + (i / totalLines) * 30; // 40% 到 70%
                updateProgress(progress, `已处理 ${Math.min(i + batchSize, totalLines)}/${totalLines} 条记录...`, 'step-process');
                
                // 让出控制权，让浏览器更新UI
                await delay(10);
            }
            
            return articles;
        }

        // 使用流式读取来显示下载进度（如果浏览器支持）
        async function fetchWithProgress(url) {
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const contentLength = response.headers.get('Content-Length');
            if (!contentLength || !response.body) {
                // 如果无法获取内容长度或不支持流，直接返回
                updateProgress(20, '正在下载文件...', 'step-fetch');
                return await response.text();
            }

            const total = parseInt(contentLength);
            let loaded = 0;
            const reader = response.body.getReader();
            const chunks = [];

            while (true) {
                const { done, value } = await reader.read();
                
                if (done) break;
                
                chunks.push(value);
                loaded += value.length;
                
                const percentage = 5 + (loaded / total) * 15; // 5% 到 20%
                updateProgress(percentage, `下载进度: ${(loaded / 1024 / 1024).toFixed(1)}MB / ${(total / 1024 / 1024).toFixed(1)}MB`, 'step-fetch');
                
                // 让出控制权
                await delay(1);
            }

            // 将所有块合并成字符串
            const allChunks = new Uint8Array(loaded);
            let position = 0;
            for (const chunk of chunks) {
                allChunks.set(chunk, position);
                position += chunk.length;
            }

            return new TextDecoder().decode(allChunks);
        }

        // 加载并处理CSV数据
        async function loadData() {
            try {
                // 步骤1: 下载文件
                updateProgress(0, '开始下载 CSV 文件...', 'step-fetch');
                await delay(100);
                
                let csvText;
                try {
                    csvText = await fetchWithProgress('data.csv');
                } catch (e) {
                    // 如果流式下载失败，使用普通方式
                    updateProgress(10, '正在下载文件...', 'step-fetch');
                    const response = await fetch('data.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    csvText = await response.text();
                }
                
                updateProgress(25, '文件下载完成！', 'step-fetch');
                await delay(200);
                
                // 步骤2: 解析数据
                updateProgress(30, '开始解析 CSV 数据...', 'step-parse');
                await delay(100);
                
                const lines = csvText.trim().split('\n').slice(1);
                const totalLines = lines.length;
                
                updateProgress(35, `发现 ${totalLines} 条记录`, 'step-parse');
                await delay(200);

                // 步骤3: 处理数据
                updateProgress(40, '开始处理文章数据...', 'step-process');
                await delay(100);
                
                allArticles = await processDataInBatches(lines);

                updateProgress(70, `数据处理完成，共解析出 ${allArticles.length} 篇文章`, 'step-process');
                await delay(300);

                // 按日期分组
                updateProgress(75, '正在按日期分组...', 'step-process');
                await delay(100);
                
                allArticles.forEach((article) => {
                    const dateKey = getGmt8DateString(article.time);
                    if (!articlesByDate.has(dateKey)) {
                        articlesByDate.set(dateKey, []);
                    }
                    articlesByDate.get(dateKey).push(article);
                });

                updateProgress(80, `数据分组完成，共 ${articlesByDate.size} 个不同日期`, 'step-process');
                await delay(200);

                // 步骤4: 生成日历
                updateProgress(85, '正在生成日历数据...', 'step-calendar');
                await delay(100);

                // 获取所有年份
                const years = [...new Set(allArticles.map(article => 
                    article.time.getFullYear()
                ))].sort((a, b) => b - a);

                updateProgress(88, `发现 ${years.length} 个年份: ${years.join(', ')}`, 'step-calendar');
                await delay(200);

                // 填充年份选择器
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });

                // 步骤5: 渲染页面
                updateProgress(90, '正在渲染页面...', 'step-render');
                await delay(100);

                // 默认显示最新年份
                currentYear = years[0]?.toString() || '';
                yearSelect.value = currentYear;

                updateProgress(93, '正在生成日历视图...', 'step-render');
                await delay(100);
                renderCalendar();
                
                updateProgress(96, '正在加载文章列表...', 'step-render');
                await delay(100);
                renderArticles(allArticles);
                updateStats();

                updateProgress(100, '加载完成！', 'step-render');
                await delay(500);

                // 标记所有步骤完成
                document.querySelectorAll('.loading-step').forEach(step => {
                    step.classList.remove('active');
                    step.classList.add('completed');
                });

                await delay(300);

                // 隐藏加载器，显示内容
                loader.style.display = 'none';
                yearSelector.style.display = 'block';
                calendarContainer.style.display = 'block';

            } catch (error) {
                updateProgress(0, `加载失败: ${error.message}`, null);
                progressBar.style.background = 'linear-gradient(90deg, #dc3545, #c82333)';
                progressText.style.color = '#dc3545';
                console.error('Failed to load or parse data:', error);
            }
        }

        // 年份选择器事件
        yearSelect.addEventListener('change', (e) => {
            currentYear = e.target.value;
            renderCalendar();
            updateStats();
            // 重置文章列表
            if (activeDateElement) {
                activeDateElement.classList.remove('active');
                activeDateElement = null;
            }
            const filteredArticles = currentYear ? 
                allArticles.filter(article => article.time.getFullYear().toString() === currentYear) :
                allArticles;
            renderArticles(filteredArticles);
        });
        
        function getGmt8DateString(date) {
            const year = date.toLocaleString('en-CA', { year: 'numeric', timeZone: 'Asia/Shanghai' });
            const month = date.toLocaleString('en-CA', { month: '2-digit', timeZone: 'Asia/Shanghai' });
            const day = date.toLocaleString('en-CA', { day: '2-digit', timeZone: 'Asia/Shanghai' });
            return `${year}-${month}-${day}`;
        }

        // 渲染日历（按月份网格显示）
        function renderCalendar() {
            monthGrid.innerHTML = '';
            
            const year = currentYear ? parseInt(currentYear) : null;
            
            if (!year) {
                monthGrid.innerHTML = '<p style="text-align: center; color: #6c757d;">请选择年份查看日历</p>';
                return;
            }

            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-calendar';
                
                const monthTitle = document.createElement('div');
                monthTitle.className = 'month-title';
                monthTitle.textContent = `${year}年${month + 1}月`;
                
                const dayGrid = document.createElement('div');
                dayGrid.className = 'day-grid';
                
                // 添加星期标题
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                weekdays.forEach(day => {
                    const weekdayCell = document.createElement('div');
                    weekdayCell.textContent = day;
                    weekdayCell.style.fontWeight = 'bold';
                    weekdayCell.style.color = '#6c757d';
                    weekdayCell.style.fontSize = '10px';
                    dayGrid.appendChild(weekdayCell);
                });
                
                // 获取当月第一天和最后一天
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startPadding = firstDay.getDay();
                
                // 添加前面的空白格子
                for (let i = 0; i < startPadding; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell';
                    dayGrid.appendChild(emptyCell);
                }
                
                // 添加当月的日期
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    dayCell.textContent = day;
                    dayCell.dataset.date = dateKey;
                    
                    const articleCount = articlesByDate.get(dateKey)?.length || 0;
                    if (articleCount > 0) {
                        dayCell.classList.add('has-articles');
                        if (articleCount > 1) {
                            const countBadge = document.createElement('span');
                            countBadge.className = 'article-count';
                            countBadge.textContent = articleCount;
                            dayCell.appendChild(countBadge);
                        }
                        
                        dayCell.addEventListener('click', () => {
                            if (dayCell.classList.contains('active')) {
                                dayCell.classList.remove('active');
                                activeDateElement = null;
                                const yearArticles = currentYear ? 
                                    allArticles.filter(article => article.time.getFullYear().toString() === currentYear) :
                                    allArticles;
                                renderArticles(yearArticles);
                            } else {
                                if (activeDateElement) {
                                    activeDateElement.classList.remove('active');
                                }
                                dayCell.classList.add('active');
                                activeDateElement = dayCell;
                                renderArticles(articlesByDate.get(dateKey) || []);
                            }
                        });
                    }
                    
                    dayGrid.appendChild(dayCell);
                }
                
                monthDiv.appendChild(monthTitle);
                monthDiv.appendChild(dayGrid);
                monthGrid.appendChild(monthDiv);
            }
        }

        // 更新统计信息
        function updateStats() {
            const filteredArticles = currentYear ? 
                allArticles.filter(article => article.time.getFullYear().toString() === currentYear) :
                allArticles;
            
            const yearText = currentYear ? `${currentYear}年` : '全部年份';
            const daysWithArticles = new Set(filteredArticles.map(article => getGmt8DateString(article.time))).size;
            
            stats.textContent = `${yearText}共${filteredArticles.length}篇文章，分布在${daysWithArticles}天`;
        }

        // 渲染文章列表（使用文档片段优化性能）
        function renderArticles(articles) {
            articleList.innerHTML = '';
            
            if (!articles || articles.length === 0) {
                articleList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">没有找到相关文章。</p>';
                return;
            }
            
            // 按时间倒序排列
            const sortedArticles = [...articles].sort((a, b) => b.time - a.time);
            
            // 使用DocumentFragment提高性能
            const fragment = document.createDocumentFragment();
            
            sortedArticles.forEach(article => {
                const articleEl = document.createElement('article');
                
                articleEl.innerHTML = `
                    <h3>${escapeHtml(article.title)}</h3>
                    <div class="meta">发布于: ${article.time.toLocaleString('zh-CN', { 
                        timeZone: 'Asia/Shanghai', 
                        hour12: false 
                    })}</div>
                    <div class="links">
                        <a href="https://web.archive.org/web/${encodeURIComponent(article.url)}" target="_blank" rel="noopener noreferrer">互联网图书馆</a>
                        <a href="https://www.bing.com/search?q=${encodeURIComponent(article.title)}" target="_blank" rel="noopener noreferrer">Bing搜索</a>
                        <a href="https://www.google.com/search?q=${encodeURIComponent(article.title)}" target="_blank" rel="noopener noreferrer">Google搜索</a>
                    </div>
                `;
                
                fragment.appendChild(articleEl);
            });
            
            articleList.appendChild(fragment);
        }

        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadData();
    });
    </script>
</body>
</html>

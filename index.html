<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« åˆ—è¡¨ä¸æ—¥å†è§†å›¾</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
            background-color: #f8f9fa;
        }
        h1 {
            text-align: center;
            color: #495057;
        }
        
        /* åŠ è½½å™¨æ ·å¼ */
        #loader {
            text-align: center;
            padding: 40px;
        }
        #loader h3 {
            margin-bottom: 20px;
            color: #495057;
        }
        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 15px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            position: relative;
        }
        .progress-text {
            margin-top: 10px;
            color: #6c757d;
            font-size: 14px;
        }
        .loading-steps {
            text-align: left;
            max-width: 300px;
            margin: 20px auto;
        }
        .loading-step {
            padding: 5px 0;
            color: #6c757d;
            font-size: 14px;
        }
        .loading-step.active {
            color: #007bff;
            font-weight: bold;
        }
        .loading-step.completed {
            color: #28a745;
        }
        .loading-step::before {
            content: "â³ ";
            margin-right: 8px;
        }
        .loading-step.active::before {
            content: "ğŸ”„ ";
        }
        .loading-step.completed::before {
            content: "âœ… ";
        }
        
        /* å¹´ä»½åˆ‡æ¢å™¨ */
        #year-selector {
            text-align: center;
            margin-bottom: 20px;
        }
        #year-selector select {
            padding: 8px 15px;
            font-size: 16px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #fff;
        }
        
        /* æœˆä»½æ—¥å†ç½‘æ ¼ */
        #calendar-container {
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
        }
        #month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .month-calendar {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .month-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            background-color: #fff;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        .day-cell:hover {
            background-color: #e3f2fd;
        }
        .day-cell.has-articles {
            background-color: #bbdefb;
            font-weight: bold;
        }
        .day-cell.active {
            background-color: #2196f3;
            color: white;
        }
        .day-cell .article-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #f44336;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        /* æ–‡ç« åˆ—è¡¨æ ·å¼ */
        #article-list {
            max-height: 600px;
            overflow-y: auto;
        }
        #article-list article {
            background-color: #fff;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        #article-list h3 {
            margin: 0 0 10px;
            font-size: 1.1em;
            color: #212529;
        }
        #article-list .meta {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }
        #article-list .links a {
            color: #007bff;
            text-decoration: none;
            margin-right: 15px;
            font-size: 0.9em;
        }
        #article-list .links a:hover {
            text-decoration: underline;
        }
        
        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats {
            text-align: center;
            color: #6c757d;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <h1>æ–‡ç« å½’æ¡£</h1>

    <div id="loader">
        <h3>æ­£åœ¨åŠ è½½æ•°æ®</h3>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">å‡†å¤‡å¼€å§‹...</div>
        
        <div class="loading-steps">
            <div class="loading-step" id="step-fetch">ä¸‹è½½ CSV æ–‡ä»¶</div>
            <div class="loading-step" id="step-parse">è§£ææ•°æ®æ ¼å¼</div>
            <div class="loading-step" id="step-process">å¤„ç†æ–‡ç« æ•°æ®</div>
            <div class="loading-step" id="step-calendar">ç”Ÿæˆæ—¥å†è§†å›¾</div>
            <div class="loading-step" id="step-render">æ¸²æŸ“é¡µé¢å†…å®¹</div>
        </div>
    </div>

    <div id="year-selector" style="display: none;">
        <label for="year-select">é€‰æ‹©å¹´ä»½ï¼š</label>
        <select id="year-select">
            <option value="">å…¨éƒ¨å¹´ä»½</option>
        </select>
    </div>

    <div id="calendar-container" style="display: none;">
        <h2>æ—¥å†è§†å›¾</h2>
        <div class="stats" id="stats"></div>
        <div id="month-grid"></div>
    </div>

    <div id="article-list"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const loader = document.getElementById('loader');
        const articleList = document.getElementById('article-list');
        const calendarContainer = document.getElementById('calendar-container');
        const yearSelector = document.getElementById('year-selector');
        const yearSelect = document.getElementById('year-select');
        const monthGrid = document.getElementById('month-grid');
        const stats = document.getElementById('stats');
        
        // è¿›åº¦ç›¸å…³å…ƒç´ 
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        let articlesByDate = new Map();
        let allArticles = [];
        let currentYear = '';
        let activeDateElement = null;

        // æ›´æ–°è¿›åº¦
        function updateProgress(percentage, text, stepId) {
            progressBar.style.width = percentage + '%';
            progressText.textContent = text;
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            if (stepId) {
                // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
                document.querySelectorAll('.loading-step').forEach(step => {
                    step.classList.remove('active', 'completed');
                });
                
                // æ ‡è®°å·²å®Œæˆçš„æ­¥éª¤å’Œå½“å‰æ­¥éª¤
                const stepIds = ['step-fetch', 'step-parse', 'step-process', 'step-calendar', 'step-render'];
                const currentIndex = stepIds.indexOf(stepId);
                
                stepIds.forEach((id, index) => {
                    const step = document.getElementById(id);
                    if (index < currentIndex) {
                        step.classList.add('completed');
                    } else if (index === currentIndex) {
                        step.classList.add('active');
                    }
                });
            }
        }

        // å»¶è¿Ÿå‡½æ•°ï¼Œç¡®ä¿UIèƒ½å¤Ÿæ›´æ–°
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // åˆ†æ‰¹å¤„ç†æ•°æ®ï¼Œé¿å…é˜»å¡UI
        async function processDataInBatches(lines, batchSize = 50) {
            const articles = [];
            const totalLines = lines.length;
            
            for (let i = 0; i < lines.length; i += batchSize) {
                const batch = lines.slice(i, i + batchSize);
                
                // å¤„ç†å½“å‰æ‰¹æ¬¡
                for (const line of batch) {
                    const parts = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            parts.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    parts.push(current);
                    
                    if (parts.length >= 4) {
                        const [id, time, title, url] = parts;
                        const cleanTitle = title.replace(/^"|"$/g, '');
                        
                        articles.push({
                            id: id.trim(),
                            time: new Date(time.trim()),
                            title: cleanTitle.trim(),
                            url: url.trim()
                        });
                    }
                }
                
                // æ›´æ–°è¿›åº¦
                const progress = 40 + (i / totalLines) * 30; // 40% åˆ° 70%
                updateProgress(progress, `å·²å¤„ç† ${Math.min(i + batchSize, totalLines)}/${totalLines} æ¡è®°å½•...`, 'step-process');
                
                // è®©å‡ºæ§åˆ¶æƒï¼Œè®©æµè§ˆå™¨æ›´æ–°UI
                await delay(10);
            }
            
            return articles;
        }

        // ä½¿ç”¨æµå¼è¯»å–æ¥æ˜¾ç¤ºä¸‹è½½è¿›åº¦ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
        async function fetchWithProgress(url) {
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const contentLength = response.headers.get('Content-Length');
            if (!contentLength || !response.body) {
                // å¦‚æœæ— æ³•è·å–å†…å®¹é•¿åº¦æˆ–ä¸æ”¯æŒæµï¼Œç›´æ¥è¿”å›
                updateProgress(20, 'æ­£åœ¨ä¸‹è½½æ–‡ä»¶...', 'step-fetch');
                return await response.text();
            }

            const total = parseInt(contentLength);
            let loaded = 0;
            const reader = response.body.getReader();
            const chunks = [];

            while (true) {
                const { done, value } = await reader.read();
                
                if (done) break;
                
                chunks.push(value);
                loaded += value.length;
                
                const percentage = 5 + (loaded / total) * 15; // 5% åˆ° 20%
                updateProgress(percentage, `ä¸‹è½½è¿›åº¦: ${(loaded / 1024 / 1024).toFixed(1)}MB / ${(total / 1024 / 1024).toFixed(1)}MB`, 'step-fetch');
                
                // è®©å‡ºæ§åˆ¶æƒ
                await delay(1);
            }

            // å°†æ‰€æœ‰å—åˆå¹¶æˆå­—ç¬¦ä¸²
            const allChunks = new Uint8Array(loaded);
            let position = 0;
            for (const chunk of chunks) {
                allChunks.set(chunk, position);
                position += chunk.length;
            }

            return new TextDecoder().decode(allChunks);
        }

        // åŠ è½½å¹¶å¤„ç†CSVæ•°æ®
        async function loadData() {
            try {
                // æ­¥éª¤1: ä¸‹è½½æ–‡ä»¶
                updateProgress(0, 'å¼€å§‹ä¸‹è½½ CSV æ–‡ä»¶...', 'step-fetch');
                await delay(100);
                
                let csvText;
                try {
                    csvText = await fetchWithProgress('data.csv');
                } catch (e) {
                    // å¦‚æœæµå¼ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨æ™®é€šæ–¹å¼
                    updateProgress(10, 'æ­£åœ¨ä¸‹è½½æ–‡ä»¶...', 'step-fetch');
                    const response = await fetch('data.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    csvText = await response.text();
                }
                
                updateProgress(25, 'æ–‡ä»¶ä¸‹è½½å®Œæˆï¼', 'step-fetch');
                await delay(200);
                
                // æ­¥éª¤2: è§£ææ•°æ®
                updateProgress(30, 'å¼€å§‹è§£æ CSV æ•°æ®...', 'step-parse');
                await delay(100);
                
                const lines = csvText.trim().split('\n').slice(1);
                const totalLines = lines.length;
                
                updateProgress(35, `å‘ç° ${totalLines} æ¡è®°å½•`, 'step-parse');
                await delay(200);

                // æ­¥éª¤3: å¤„ç†æ•°æ®
                updateProgress(40, 'å¼€å§‹å¤„ç†æ–‡ç« æ•°æ®...', 'step-process');
                await delay(100);
                
                allArticles = await processDataInBatches(lines);

                updateProgress(70, `æ•°æ®å¤„ç†å®Œæˆï¼Œå…±è§£æå‡º ${allArticles.length} ç¯‡æ–‡ç« `, 'step-process');
                await delay(300);

                // æŒ‰æ—¥æœŸåˆ†ç»„
                updateProgress(75, 'æ­£åœ¨æŒ‰æ—¥æœŸåˆ†ç»„...', 'step-process');
                await delay(100);
                
                allArticles.forEach((article) => {
                    const dateKey = getGmt8DateString(article.time);
                    if (!articlesByDate.has(dateKey)) {
                        articlesByDate.set(dateKey, []);
                    }
                    articlesByDate.get(dateKey).push(article);
                });

                updateProgress(80, `æ•°æ®åˆ†ç»„å®Œæˆï¼Œå…± ${articlesByDate.size} ä¸ªä¸åŒæ—¥æœŸ`, 'step-process');
                await delay(200);

                // æ­¥éª¤4: ç”Ÿæˆæ—¥å†
                updateProgress(85, 'æ­£åœ¨ç”Ÿæˆæ—¥å†æ•°æ®...', 'step-calendar');
                await delay(100);

                // è·å–æ‰€æœ‰å¹´ä»½
                const years = [...new Set(allArticles.map(article => 
                    article.time.getFullYear()
                ))].sort((a, b) => b - a);

                updateProgress(88, `å‘ç° ${years.length} ä¸ªå¹´ä»½: ${years.join(', ')}`, 'step-calendar');
                await delay(200);

                // å¡«å……å¹´ä»½é€‰æ‹©å™¨
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });

                // æ­¥éª¤5: æ¸²æŸ“é¡µé¢
                updateProgress(90, 'æ­£åœ¨æ¸²æŸ“é¡µé¢...', 'step-render');
                await delay(100);

                // é»˜è®¤æ˜¾ç¤ºæœ€æ–°å¹´ä»½
                currentYear = years[0]?.toString() || '';
                yearSelect.value = currentYear;

                updateProgress(93, 'æ­£åœ¨ç”Ÿæˆæ—¥å†è§†å›¾...', 'step-render');
                await delay(100);
                renderCalendar();
                
                updateProgress(96, 'æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...', 'step-render');
                await delay(100);
                renderArticles(allArticles);
                updateStats();

                updateProgress(100, 'åŠ è½½å®Œæˆï¼', 'step-render');
                await delay(500);

                // æ ‡è®°æ‰€æœ‰æ­¥éª¤å®Œæˆ
                document.querySelectorAll('.loading-step').forEach(step => {
                    step.classList.remove('active');
                    step.classList.add('completed');
                });

                await delay(300);

                // éšè—åŠ è½½å™¨ï¼Œæ˜¾ç¤ºå†…å®¹
                loader.style.display = 'none';
                yearSelector.style.display = 'block';
                calendarContainer.style.display = 'block';

            } catch (error) {
                updateProgress(0, `åŠ è½½å¤±è´¥: ${error.message}`, null);
                progressBar.style.background = 'linear-gradient(90deg, #dc3545, #c82333)';
                progressText.style.color = '#dc3545';
                console.error('Failed to load or parse data:', error);
            }
        }

        // å¹´ä»½é€‰æ‹©å™¨äº‹ä»¶
        yearSelect.addEventListener('change', (e) => {
            currentYear = e.target.value;
            renderCalendar();
            updateStats();
            // é‡ç½®æ–‡ç« åˆ—è¡¨
            if (activeDateElement) {
                activeDateElement.classList.remove('active');
                activeDateElement = null;
            }
            const filteredArticles = currentYear ? 
                allArticles.filter(article => article.time.getFullYear().toString() === currentYear) :
                allArticles;
            renderArticles(filteredArticles);
        });
        
        function getGmt8DateString(date) {
            const year = date.toLocaleString('en-CA', { year: 'numeric', timeZone: 'Asia/Shanghai' });
            const month = date.toLocaleString('en-CA', { month: '2-digit', timeZone: 'Asia/Shanghai' });
            const day = date.toLocaleString('en-CA', { day: '2-digit', timeZone: 'Asia/Shanghai' });
            return `${year}-${month}-${day}`;
        }

        // æ¸²æŸ“æ—¥å†ï¼ˆæŒ‰æœˆä»½ç½‘æ ¼æ˜¾ç¤ºï¼‰
        function renderCalendar() {
            monthGrid.innerHTML = '';
            
            const year = currentYear ? parseInt(currentYear) : null;
            
            if (!year) {
                monthGrid.innerHTML = '<p style="text-align: center; color: #6c757d;">è¯·é€‰æ‹©å¹´ä»½æŸ¥çœ‹æ—¥å†</p>';
                return;
            }

            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-calendar';
                
                const monthTitle = document.createElement('div');
                monthTitle.className = 'month-title';
                monthTitle.textContent = `${year}å¹´${month + 1}æœˆ`;
                
                const dayGrid = document.createElement('div');
                dayGrid.className = 'day-grid';
                
                // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                weekdays.forEach(day => {
                    const weekdayCell = document.createElement('div');
                    weekdayCell.textContent = day;
                    weekdayCell.style.fontWeight = 'bold';
                    weekdayCell.style.color = '#6c757d';
                    weekdayCell.style.fontSize = '10px';
                    dayGrid.appendChild(weekdayCell);
                });
                
                // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startPadding = firstDay.getDay();
                
                // æ·»åŠ å‰é¢çš„ç©ºç™½æ ¼å­
                for (let i = 0; i < startPadding; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell';
                    dayGrid.appendChild(emptyCell);
                }
                
                // æ·»åŠ å½“æœˆçš„æ—¥æœŸ
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    dayCell.textContent = day;
                    dayCell.dataset.date = dateKey;
                    
                    const articleCount = articlesByDate.get(dateKey)?.length || 0;
                    if (articleCount > 0) {
                        dayCell.classList.add('has-articles');
                        if (articleCount > 1) {
                            const countBadge = document.createElement('span');
                            countBadge.className = 'article-count';
                            countBadge.textContent = articleCount;
                            dayCell.appendChild(countBadge);
                        }
                        
                        dayCell.addEventListener('click', () => {
                            if (dayCell.classList.contains('active')) {
                                dayCell.classList.remove('active');
                                activeDateElement = null;
                                const yearArticles = currentYear ? 
                                    allArticles.filter(article => article.time.getFullYear().toString() === currentYear) :
                                    allArticles;
                                renderArticles(yearArticles);
                            } else {
                                if (activeDateElement) {
                                    activeDateElement.classList.remove('active');
                                }
                                dayCell.classList.add('active');
                                activeDateElement = dayCell;
                                renderArticles(articlesByDate.get(dateKey) || []);
                            }
                        });
                    }
                    
                    dayGrid.appendChild(dayCell);
                }
                
                monthDiv.appendChild(monthTitle);
                monthDiv.appendChild(dayGrid);
                monthGrid.appendChild(monthDiv);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const filteredArticles = currentYear ? 
                allArticles.filter(article => article.time.getFullYear().toString() === currentYear) :
                allArticles;
            
            const yearText = currentYear ? `${currentYear}å¹´` : 'å…¨éƒ¨å¹´ä»½';
            const daysWithArticles = new Set(filteredArticles.map(article => getGmt8DateString(article.time))).size;
            
            stats.textContent = `${yearText}å…±${filteredArticles.length}ç¯‡æ–‡ç« ï¼Œåˆ†å¸ƒåœ¨${daysWithArticles}å¤©`;
        }

        // æ¸²æŸ“æ–‡ç« åˆ—è¡¨ï¼ˆä½¿ç”¨æ–‡æ¡£ç‰‡æ®µä¼˜åŒ–æ€§èƒ½ï¼‰
        function renderArticles(articles) {
            articleList.innerHTML = '';
            
            if (!articles || articles.length === 0) {
                articleList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« ã€‚</p>';
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedArticles = [...articles].sort((a, b) => b.time - a.time);
            
            // ä½¿ç”¨DocumentFragmentæé«˜æ€§èƒ½
            const fragment = document.createDocumentFragment();
            
            sortedArticles.forEach(article => {
                const articleEl = document.createElement('article');
                
                articleEl.innerHTML = `
                    <h3>${escapeHtml(article.title)}</h3>
                    <div class="meta">å‘å¸ƒäº: ${article.time.toLocaleString('zh-CN', { 
                        timeZone: 'Asia/Shanghai', 
                        hour12: false 
                    })}</div>
                    <div class="links">
                        <a href="https://web.archive.org/web/${encodeURIComponent(article.url)}" target="_blank" rel="noopener noreferrer">äº’è”ç½‘å›¾ä¹¦é¦†</a>
                        <a href="https://www.bing.com/search?q=${encodeURIComponent(article.title)}" target="_blank" rel="noopener noreferrer">Bingæœç´¢</a>
                        <a href="https://www.google.com/search?q=${encodeURIComponent(article.title)}" target="_blank" rel="noopener noreferrer">Googleæœç´¢</a>
                    </div>
                `;
                
                fragment.appendChild(articleEl);
            });
            
            articleList.appendChild(fragment);
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        loadData();
    });
    </script>
</body>
</html>
